<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout}">
<head>
    <title>User Details</title>
</head>

<div layout:fragment="content">
    <!-- Back Button -->
    <div class="mb-3">
        <a th:href="@{/admin/users}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Users
        </a>
    </div>

    <div class="row">
        <!-- User Profile -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user"></i> User Profile</h5>
                </div>
                <div class="card-body text-center">
                    <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 80px; height: 80px; font-size: 2rem;">
                        <span th:text="${user.firstName.substring(0,1).toUpperCase()}">U</span>
                    </div>
                    <h4 th:text="${user.firstName + ' ' + user.lastName}">User Name</h4>
                    <p class="text-muted" th:text="${user.email}">user@email.com</p>
                    
                    <div class="row text-center">
                        <div class="col">
                            <span th:class="${user.role.name() == 'ADMIN'} ? 'badge bg-danger fs-6' : 'badge bg-primary fs-6'" 
                                  th:text="${user.role.name()}">Role</span>
                        </div>
                        <div class="col">
                            <span th:class="${user.emailVerified} ? 'badge bg-success fs-6' : 'badge bg-warning fs-6'" 
                                  th:text="${user.emailVerified} ? 'Verified' : 'Pending'">Status</span>
                        </div>
                    </div>

                    <hr>
                    
                    <div class="row text-center small">
                        <div class="col-12 mb-2">
                            <strong>Joined:</strong><br>
                            <span th:text="${#temporals.format(user.createdAt, 'MMM dd, yyyy HH:mm')}">Date</span>
                        </div>
                        <div class="col-12">
                            <strong>User ID:</strong> <span th:text="${user.id}">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> User Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h4>₹<span th:text="${userStats.totalExpenses}">0</span></h4>
                                    <small>Total Expenses</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>₹<span th:text="${userStats.totalIncome}">0</span></h4>
                                    <small>Total Income</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>₹<span th:text="${userStats.currentMonthExpenses}">0</span></h4>
                                    <small>This Month</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>₹<span th:text="${userStats.balance}">0</span></h4>
                                    <small>Balance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Expenses -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-receipt"></i> Recent Expenses</h5>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(expenses)}" class="text-center text-muted py-4">
                        <i class="fas fa-receipt fa-3x mb-3"></i>
                        <p>No expenses recorded</p>
                    </div>
                    <div th:unless="${#lists.isEmpty(expenses)}" style="max-height: 400px; overflow-y: auto;">
                        <div th:each="expense, iterStat : ${expenses}" 
                             th:if="${iterStat.index < 10}"
                             class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong th:text="${expense.title}">Title</strong>
                                <small class="text-muted d-block">
                                    <span th:text="${expense.category}">Category</span> • 
                                    <span th:text="${#temporals.format(expense.transactionDate, 'MMM dd')}">Date</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <span th:class="${expense.type.name() == 'EXPENSE'} ? 'text-danger fw-bold' : 'text-success fw-bold'">
                                    <span th:if="${expense.type.name() == 'EXPENSE'}">-</span>₹<span th:text="${expense.amount}">0</span>
                                </span>
                            </div>
                        </div>
                        <div th:if="${#lists.size(expenses) > 10}" class="text-center mt-3">
                            <small class="text-muted">Showing 10 of <span th:text="${#lists.size(expenses)}">0</span> expenses</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Budgets -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Active Budgets</h5>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(budgets)}" class="text-center text-muted py-4">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>No budgets set</p>
                    </div>
                    <div th:unless="${#lists.isEmpty(budgets)}" style="max-height: 400px; overflow-y: auto;">
                        <div th:each="budget : ${budgets}" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong th:text="${budget.category}">Category</strong>
                                <span class="fw-bold text-primary">₹<span th:text="${budget.amount}">0</span></span>
                            </div>
                            <small class="text-muted">
                                <span th:text="${#temporals.format(T(java.time.LocalDate).of(budget.year, budget.month, 1), 'MMMM yyyy')}">Month Year</span>
                            </small>
                            <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 45%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-cogs"></i> User Actions</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <form th:action="@{/admin/users/{id}/toggle-status(id=${user.id})}" method="post" class="d-inline w-100">
                        <button type="submit" 
                                th:class="${user.emailVerified} ? 'btn btn-warning w-100' : 'btn btn-success w-100'">
                            <i th:class="${user.emailVerified} ? 'fas fa-user-times' : 'fas fa-user-check'"></i>
                            <span th:text="${user.emailVerified} ? 'Disable User' : 'Enable User'">Action</span>
                        </button>
                    </form>
                </div>
                <div class="col-md-3 mb-2" th:if="${user.role.name() != 'ADMIN'}">
                    <form th:action="@{/admin/users/{id}/delete(id=${user.id})}" method="post" class="d-inline w-100">
                        <button type="submit" class="btn btn-danger w-100"
                                onclick="return confirm('Are you sure you want to delete this user? This will also delete all their expenses and budgets. This action cannot be undone.')">
                            <i class="fas fa-trash"></i> Delete User
                        </button>
                    </form>
                </div>
                <div class="col-md-3 mb-2">
                    <a th:href="@{/admin/users}" class="btn btn-secondary w-100">
                        <i class="fas fa-list"></i> Back to Users
                    </a>
                </div>
                <div class="col-md-3 mb-2">
                    <a th:href="@{/admin/dashboard}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
</html>